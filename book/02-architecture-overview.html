<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js oranda-dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Architecture Overview - rsketch</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="Documentation for rsketch - A Rust project template with gRPC and multi-language code generation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">
        <link rel="stylesheet" href="oranda-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "oranda-dark" : "oranda-dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('orandamdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('orandamdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('orandamdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('oranda-dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="01-background.html"><strong aria-hidden="true">1.</strong> Background</a></li><li class="chapter-item expanded "><a href="02-architecture-overview.html" class="active"><strong aria-hidden="true">2.</strong> Architecture Overview</a></li><li class="chapter-item expanded "><a href="03-record-manager.html"><strong aria-hidden="true">3.</strong> Table Manager</a></li><li class="chapter-item expanded "><a href="04-core-storage-components.html"><strong aria-hidden="true">4.</strong> Core Storage Components</a></li><li class="chapter-item expanded "><a href="05-file-system-integration.html"><strong aria-hidden="true">5.</strong> File System Integration</a></li><li class="chapter-item expanded "><a href="06-performance-optimization.html"><strong aria-hidden="true">6.</strong> Performance Optimization</a></li><li class="chapter-item expanded "><a href="07-reliability-and-recovery.html"><strong aria-hidden="true">7.</strong> Reliability and Recovery</a></li><li class="chapter-item expanded "><a href="08-configuration-and-api.html"><strong aria-hidden="true">8.</strong> Configuration and API</a></li><li class="chapter-item expanded "><a href="09-monitoring-and-observability.html"><strong aria-hidden="true">9.</strong> Monitoring and Observability</a></li><li class="chapter-item expanded "><a href="10-deployment-and-operations.html"><strong aria-hidden="true">10.</strong> Deployment and Operations</a></li><li class="chapter-item expanded "><a href="11-security.html"><strong aria-hidden="true">11.</strong> Security</a></li><li class="chapter-item expanded "><a href="12-testing-strategy.html"><strong aria-hidden="true">12.</strong> Testing Strategy</a></li><li class="chapter-item expanded "><a href="13-future-enhancements.html"><strong aria-hidden="true">13.</strong> Future Enhancements</a></li><li class="chapter-item expanded "><a href="14-implementation-roadmap.html"><strong aria-hidden="true">14.</strong> Implementation Roadmap</a></li><li class="chapter-item expanded "><a href="15-distributed-architecture.html"><strong aria-hidden="true">15.</strong> Distributed Architecture</a></li><li class="chapter-item expanded "><a href="16-component-design.html"><strong aria-hidden="true">16.</strong> Component Design</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="oranda-dark">Oranda Dark</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="oranda-light">Oranda Light</button></li>

                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rsketch</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/crrow/rsketch" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/crrow/rsketch/edit/main/docs/src/02-architecture-overview.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="filestore分层架构设计"><a class="header" href="#filestore分层架构设计">FileStore分层架构设计</a></h1>
<h2 id="架构总览"><a class="header" href="#架构总览">架构总览</a></h2>
<p>FileStore是一个专为交易系统设计的高性能存储引擎，采用分层架构来实现亚毫秒级延迟和高吞吐量。系统基于内存映射技术，通过硬件感知优化和专用数据结构来达到极致性能。</p>
<h2 id="核心设计哲学"><a class="header" href="#核心设计哲学">核心设计哲学</a></h2>
<h3 id="1-简化架构原则"><a class="header" href="#1-简化架构原则">1. 简化架构原则</a></h3>
<p>针对内网环境和纯存储需求，采用四层精简架构：</p>
<ul>
<li><strong>接口层</strong>: 高性能通信接口 (gRPC/TCP)</li>
<li><strong>存储引擎层</strong>: 核心数据管理和索引</li>
<li><strong>持久化层</strong>: 高效WAL和异步刷盘</li>
<li><strong>硬件层</strong>: 直接硬件访问优化</li>
</ul>
<h3 id="2-极致性能理念"><a class="header" href="#2-极致性能理念">2. 极致性能理念</a></h3>
<ul>
<li><strong>零业务开销</strong>: 无业务逻辑层，直达存储引擎</li>
<li><strong>零抽象开销</strong>: 直接内存访问，消除序列化开销</li>
<li><strong>编译时优化</strong>: 利用Rust零成本抽象</li>
<li><strong>硬件直通</strong>: 绕过OS层，直接访问NVMe和内存</li>
</ul>
<h2 id="四层精简架构设计"><a class="header" href="#四层精简架构设计">四层精简架构设计</a></h2>
<h3 id="架构总览图"><a class="header" href="#架构总览图">架构总览图</a></h3>
<pre><code class="language-mermaid">graph TB
    subgraph "FileStore 简化架构 (内网环境)"
        subgraph "第一层：高性能接口层"
            INT[协议处理器&lt;br/&gt;gRPC/TCP直连]
            CONN[连接管理器&lt;br/&gt;零拷贝缓冲区]
            MON[基础监控&lt;br/&gt;延迟/QPS统计]
        end

        subgraph "第二层：存储引擎核心"
            subgraph "表管理引擎"
                TBL[表注册中心]
                CRUD[记录CRUD引擎]
                QE[查询执行器]
                CACHE[结果缓存]
            end
            
            subgraph "索引系统"
                PI[主索引引擎&lt;br/&gt;RecordID→Slot]
                SI[二级索引引擎&lt;br/&gt;Field→RecordIDs]
                IDX_CACHE[索引缓存]
                OPT[查询优化器]
            end
            
            subgraph "并发控制引擎"
                MVCC[MVCC版本管理]
                LOCK[无锁数据结构]
                TXN[事务协调器]
                DEAD[死锁检测器]
            end
            
            subgraph "内存管理引擎"
                NUMA[NUMA感知分配器]
                PAGE[页面分配器]
                POOL[内存池管理器]
                HOT[热点数据管理]
            end
        end

        subgraph "第三层：高效持久化层"
            subgraph "极速WAL引擎"
                WAL_WRITE[直接NVMe写入]
                WAL_BATCH[批量日志写入]
                WAL_ZERO[零拷贝日志缓冲]
            end
            
            subgraph "智能刷盘管理器"
                FLUSH_BATCH[页面级批量刷盘]
                FLUSH_ASYNC[后台异步刷盘]
                FLUSH_PRIORITY[热页面优先级]
            end
            
            subgraph "快速恢复引擎"
                CHECKPOINT[增量检查点]
                RECOVERY[并行恢复]
                SNAPSHOT[内存快照]
            end
        end

        subgraph "第四层：硬件直通层"
            subgraph "用户态存储引擎"
                SPDK[SPDK NVMe驱动]
                IOQUEUE[用户态I/O队列]
                DMA[直接内存访问]
            end
            
            subgraph "NUMA内存优化器"
                LOCAL_MEM[本地内存分配]
                CROSS_MIN[跨节点访问最小化]
                HUGE_PAGE[大页面管理]
            end
            
            subgraph "CPU性能加速器"
                CACHE_ALIGN[缓存行对齐]
                SIMD[SIMD向量化]
                THREAD_BIND[线程CPU绑定]
            end
        end
    end

    INT --&gt; TBL
    CONN --&gt; CRUD
    MON --&gt; QE
    
    TBL --&gt; PI
    CRUD --&gt; SI
    QE --&gt; IDX_CACHE
    CACHE --&gt; OPT
    
    PI --&gt; MVCC
    SI --&gt; LOCK
    IDX_CACHE --&gt; TXN
    OPT --&gt; DEAD
    
    MVCC --&gt; NUMA
    LOCK --&gt; PAGE
    TXN --&gt; POOL
    DEAD --&gt; HOT
    
    NUMA --&gt; WAL_WRITE
    PAGE --&gt; WAL_BATCH
    POOL --&gt; WAL_ZERO
    HOT --&gt; FLUSH_BATCH
    
    WAL_WRITE --&gt; SPDK
    WAL_BATCH --&gt; IOQUEUE
    FLUSH_BATCH --&gt; DMA
    FLUSH_ASYNC --&gt; LOCAL_MEM
    
    SPDK --&gt; CACHE_ALIGN
    IOQUEUE --&gt; SIMD
    DMA --&gt; THREAD_BIND
</code></pre>
<h3 id="架构演进对比"><a class="header" href="#架构演进对比">架构演进对比</a></h3>
<pre><code class="language-mermaid">graph LR
    subgraph "架构简化对比 - 延迟优化"
        subgraph "原六层架构 (复杂业务系统)"
            A1[网络传输: 2ms]
            A2[API网关: 1ms]
            A3[业务服务: 2ms]
            A4[数据服务: 3ms]
            A5[存储引擎: 2ms]
            A6[持久化层: 1ms]
            A7[硬件层: 1ms]
            TOTAL_A[总延迟: 12ms]
        end

        subgraph "新四层架构 (内网存储引擎)"
            B1[网络传输: 0.1ms]
            B2[接口层: 0.5ms]
            B3[存储引擎: 6ms]
            B4[持久化层: 0.5ms]
            B5[硬件层: 0.4ms]
            BUFFER[缓冲时间: 2.5ms]
            TOTAL_B[总延迟: 10ms&lt;br/&gt;实际可达: 7.5ms]
        end

        subgraph "性能提升分析"
            IMPROVE1[网络优化: 20x提升&lt;br/&gt;2ms → 0.1ms]
            IMPROVE2[业务简化: 去除3ms&lt;br/&gt;业务逻辑开销]
            IMPROVE3[存储优化: 集中化&lt;br/&gt;60%计算预算]
            IMPROVE4[I/O优化: 2.5x提升&lt;br/&gt;用户态直通]
        end
    end

    A1 --&gt; A2 --&gt; A3 --&gt; A4 --&gt; A5 --&gt; A6 --&gt; A7 --&gt; TOTAL_A
    B1 --&gt; B2 --&gt; B3 --&gt; B4 --&gt; B5 --&gt; BUFFER --&gt; TOTAL_B
    
    A1 -.-&gt; IMPROVE1
    A3 -.-&gt; IMPROVE2
    A5 -.-&gt; IMPROVE3
    A6 -.-&gt; IMPROVE4
</code></pre>
<h3 id="-第一层高性能接口层-high-performance-interface-layer"><a class="header" href="#-第一层高性能接口层-high-performance-interface-layer">⚡ 第一层：高性能接口层 (High-Performance Interface Layer)</a></h3>
<p><strong>核心职责</strong>:</p>
<ul>
<li>极简通信协议 (优化的gRPC/直接TCP)</li>
<li>零拷贝数据传输</li>
<li>连接池和会话复用</li>
<li>基础监控和度量</li>
</ul>
<p><strong>简化组件</strong>:</p>
<pre><code>High-Performance Interface
├── 协议处理器 (Protocol Handler)
│   ├── 优化gRPC服务 (最小化序列化)
│   ├── 直接TCP通信 (绕过HTTP开销)
│   └── 共享内存IPC (同机部署)
├── 连接管理器 (Connection Manager)
│   ├── 连接池 (避免连接建立开销)
│   ├── 会话复用 (批量请求)
│   └── 零拷贝缓冲区管理
└── 性能监控 (Minimal Metrics)
    ├── 延迟统计 (P50/P99)
    ├── 吞吐量计数 (QPS)
    └── 错误率监控
</code></pre>
<p><strong>极致性能设计</strong>:</p>
<ul>
<li><strong>延迟目标</strong>: &lt; 500μs (5%的总延迟预算)</li>
<li><strong>零业务逻辑</strong>: 直接路由到存储引擎</li>
<li><strong>零拷贝</strong>: 内存映射 + 直接指针传递</li>
<li><strong>批量处理</strong>: 多请求批量执行</li>
</ul>
<h3 id="-第二层存储引擎核心-storage-engine-core"><a class="header" href="#-第二层存储引擎核心-storage-engine-core">🏗️ 第二层：存储引擎核心 (Storage Engine Core)</a></h3>
<p><strong>核心职责</strong>:</p>
<ul>
<li>表管理和记录操作 (整合原数据服务层功能)</li>
<li>高性能索引系统和查询执行</li>
<li>MVCC并发控制和事务管理</li>
<li>内存管理和硬件资源调度</li>
</ul>
<p><strong>统一组件架构</strong>:</p>
<pre><code>Unified Storage Engine
├── 表管理引擎 (Table Management Engine)
│   ├── 表注册和schema管理 (Table Registry)
│   ├── 记录CRUD引擎 (Record CRUD Engine)
│   ├── 查询执行器 (Query Executor)
│   └── 结果缓存 (Result Cache)
├── 高性能索引系统 (High-Performance Index System)
│   ├── 主索引引擎 (Primary Index: RecordID → Slot)
│   ├── 二级索引引擎 (Secondary Index: Field → RecordIDs)
│   ├── 索引缓存管理 (Index Cache Manager)
│   └── 查询优化器 (Query Optimizer)
├── 并发控制引擎 (Concurrency Control Engine)
│   ├── MVCC版本管理 (MVCC Version Manager)
│   ├── 无锁数据结构 (Lock-Free Structures)
│   ├── 事务协调器 (Transaction Coordinator)
│   └── 死锁检测器 (Deadlock Detector)
└── 内存管理引擎 (Memory Management Engine)
    ├── NUMA感知分配器 (NUMA-Aware Allocator)
    ├── 页面分配器 (Page-Aligned Allocator)
    ├── 内存池管理器 (Memory Pool Manager)
    └── 热点数据管理 (Hot Data Manager)
</code></pre>
<p><strong>极致性能设计</strong>:</p>
<ul>
<li><strong>延迟目标</strong>: &lt; 6ms (60%的总延迟预算，包含原数据服务层功能)</li>
<li><strong>零抽象开销</strong>: 直接内存访问，无序列化/反序列化</li>
<li><strong>CPU缓存优化</strong>: 数据结构64字节对齐，批处理操作</li>
<li><strong>NUMA本地化</strong>: 线程和数据绑定到同一NUMA节点</li>
</ul>
<h3 id="-第三层高效持久化层-high-performance-persistence-layer"><a class="header" href="#-第三层高效持久化层-high-performance-persistence-layer">💾 第三层：高效持久化层 (High-Performance Persistence Layer)</a></h3>
<p><strong>核心职责</strong>:</p>
<ul>
<li>极速WAL写入 (同步保证一致性)</li>
<li>智能异步刷盘 (优化I/O吞吐)</li>
<li>轻量级快照和恢复</li>
<li>最小化I/O开销</li>
</ul>
<p><strong>优化组件</strong>:</p>
<pre><code>High-Performance Persistence
├── 极速WAL引擎 (Ultra-Fast WAL Engine)
│   ├── 直接NVMe写入 (Direct NVMe Write)
│   ├── 批量日志写入 (Batched Log Write)
│   ├── 零拷贝日志缓冲 (Zero-Copy Log Buffer)
│   └── 并发日志写入 (Concurrent Log Writers)
├── 智能刷盘管理器 (Smart Flush Manager)
│   ├── 页面级批量刷盘 (Page-Level Batch Flush)
│   ├── 后台异步刷盘 (Background Async Flush)
│   ├── 热页面优先级 (Hot Page Priority)
│   └── I/O合并优化 (I/O Coalescing)
└── 快速恢复引擎 (Fast Recovery Engine)
    ├── 增量检查点 (Incremental Checkpoint)
    ├── 并行恢复 (Parallel Recovery)
    ├── 内存快照 (Memory Snapshot)
    └── 一致性快速验证 (Fast Consistency Check)
</code></pre>
<p><strong>极致性能设计</strong>:</p>
<ul>
<li><strong>WAL延迟</strong>: &lt; 500μs (直接NVMe访问，5%的总延迟预算)</li>
<li><strong>异步刷盘</strong>: 后台批量I/O，不影响前台延迟</li>
<li><strong>零拷贝</strong>: 内存直接映射到存储</li>
<li><strong>并发写入</strong>: 多个WAL写入器并行工作</li>
</ul>
<h3 id="-第四层硬件直通层-hardware-direct-access-layer"><a class="header" href="#-第四层硬件直通层-hardware-direct-access-layer">⚡ 第四层：硬件直通层 (Hardware Direct Access Layer)</a></h3>
<p><strong>核心职责</strong>:</p>
<ul>
<li>NVMe用户态直接访问 (绕过内核)</li>
<li>NUMA感知内存管理</li>
<li>CPU缓存优化和SIMD加速</li>
<li>网络零拷贝优化 (内网环境)</li>
</ul>
<p><strong>直通组件</strong>:</p>
<pre><code>Hardware Direct Access
├── 用户态存储引擎 (User-Space Storage Engine)
│   ├── SPDK NVMe驱动 (SPDK NVMe Driver)
│   ├── 用户态I/O队列 (User-Space I/O Queues)
│   ├── 直接内存访问 (Direct Memory Access)
│   └── 中断绑定优化 (Interrupt Affinity)
├── NUMA内存优化器 (NUMA Memory Optimizer)
│   ├── 本地内存分配 (Local Memory Allocation)
│   ├── 跨节点访问最小化 (Cross-Node Access Minimization)
│   ├── 大页面管理 (Huge Page Management)
│   └── 内存预取策略 (Memory Prefetching Strategy)
└── CPU性能加速器 (CPU Performance Accelerator)
    ├── 缓存行对齐 (Cache Line Alignment)
    ├── 分支预测优化 (Branch Prediction Optimization)
    ├── SIMD向量化 (SIMD Vectorization)
    └── 线程CPU绑定 (Thread-CPU Affinity)
</code></pre>
<p><strong>硬件级性能设计</strong>:</p>
<ul>
<li><strong>存储延迟</strong>: &lt; 400μs (用户态NVMe访问，4%的总延迟预算)</li>
<li><strong>内存延迟</strong>: &lt; 50ns (NUMA本地访问)</li>
<li><strong>CPU缓存</strong>: &lt; 5ns (L1缓存命中率 &gt; 95%)</li>
<li><strong>网络延迟</strong>: &lt; 100μs (内网RDMA/共享内存，1%的总延迟预算)</li>
</ul>
<h2 id="精简层间通信"><a class="header" href="#精简层间通信">精简层间通信</a></h2>
<h3 id="高效接口设计"><a class="header" href="#高效接口设计">高效接口设计</a></h3>
<ul>
<li><strong>直接调用</strong>: 层间直接函数调用，避免网络开销</li>
<li><strong>零拷贝</strong>: 指针传递，避免数据复制</li>
<li><strong>批量处理</strong>: 单次调用处理多个请求</li>
<li><strong>最小监控</strong>: 仅关键性能指标</li>
</ul>
<h3 id="简化数据流"><a class="header" href="#简化数据流">简化数据流</a></h3>
<pre><code>极简请求流程 (内网环境):
Client → 高性能接口层 → 存储引擎核心 → 持久化层 → 硬件直通层
  ↓         (0.5ms)        (6ms)        (0.5ms)     (0.4ms)
Response ←─────────────── Direct Memory Access ─────────────────→
</code></pre>
<h3 id="性能保证机制"><a class="header" href="#性能保证机制">性能保证机制</a></h3>
<ul>
<li><strong>严格延迟预算</strong>: 每层延迟预算硬性约束</li>
<li><strong>快速失败</strong>: 超时立即返回错误，不等待</li>
<li><strong>降级策略</strong>: 关闭非关键功能，保证核心性能</li>
<li><strong>实时监控</strong>: P99延迟实时监控和告警</li>
</ul>
<h2 id="关键技术决策"><a class="header" href="#关键技术决策">关键技术决策</a></h2>
<h3 id="1-内存-vs-磁盘存储策略"><a class="header" href="#1-内存-vs-磁盘存储策略">1. 内存 vs 磁盘存储策略</a></h3>
<p><strong>决策</strong>: 激进的内存优先策略 (内网环境优势)</p>
<ul>
<li><strong>热数据</strong>: 100%常驻内存 (无磁盘访问)</li>
<li><strong>温数据</strong>: 内存 + 异步刷盘 (后台持久化)</li>
<li><strong>冷数据</strong>: 压缩存储 (定期归档)</li>
</ul>
<h3 id="2-同步-vs-异步持久化"><a class="header" href="#2-同步-vs-异步持久化">2. 同步 vs 异步持久化</a></h3>
<p><strong>决策</strong>: 混合策略 + 内网优化</p>
<ul>
<li><strong>关键路径</strong>: 快速WAL写入 (&lt;500μs到本地NVMe)</li>
<li><strong>数据文件</strong>: 异步批量刷盘 (不影响前台)</li>
<li><strong>网络同步</strong>: 利用内网高速网络做实时备份</li>
</ul>
<h3 id="3-单机-vs-分布式架构"><a class="header" href="#3-单机-vs-分布式架构">3. 单机 vs 分布式架构</a></h3>
<p><strong>决策</strong>: 单机优化优先 (内网环境)</p>
<ul>
<li><strong>第一阶段</strong>: 单机极致性能优化</li>
<li><strong>第二阶段</strong>: 同机房主备 (内网高速复制)</li>
<li><strong>第三阶段</strong>: 必要时分片 (但优先垂直扩展)</li>
</ul>
<h3 id="4-一致性模型选择"><a class="header" href="#4-一致性模型选择">4. 一致性模型选择</a></h3>
<p><strong>决策</strong>: 简化一致性 (内网信任环境)</p>
<ul>
<li><strong>写一致性</strong>: 强一致性WAL + 异步数据文件</li>
<li><strong>读一致性</strong>: 直接内存读取，无一致性开销</li>
<li><strong>跨表一致性</strong>: 应用层保证 (减少系统复杂性)</li>
</ul>
<h2 id="性能目标重新分配"><a class="header" href="#性能目标重新分配">性能目标重新分配</a></h2>
<h3 id="内网优化延迟分解"><a class="header" href="#内网优化延迟分解">内网优化延迟分解</a></h3>
<pre><code>总延迟目标: P99 &lt; 10ms (内网环境)
├── 网络传输: 0.1ms (1%) ← 内网RDMA/共享内存
├── 接口层: 0.5ms (5%) ← 最小化协议开销
├── 存储引擎: 6ms (60%) ← 核心计算密集
├── 持久化层: 0.5ms (5%) ← 直接NVMe访问
├── 硬件层: 0.4ms (4%) ← 用户态I/O
└── 缓冲时间: 2.5ms (25%) ← 预留突发处理
</code></pre>
<h3 id="吞吐量目标"><a class="header" href="#吞吐量目标">吞吐量目标</a></h3>
<ul>
<li><strong>读操作</strong>: 1M+ QPS (点查询)</li>
<li><strong>写操作</strong>: 100K+ QPS (插入/更新)</li>
<li><strong>复合操作</strong>: 50K+ QPS (事务处理)</li>
<li><strong>批量操作</strong>: 10M+ records/second (批处理)</li>
</ul>
<h3 id="资源利用率"><a class="header" href="#资源利用率">资源利用率</a></h3>
<ul>
<li><strong>CPU利用率</strong>: 70-80% (避免过载)</li>
<li><strong>内存利用率</strong>: 80-90% (充分利用)</li>
<li><strong>存储I/O</strong>: 60-70% (留余量处理突发)</li>
<li><strong>网络带宽</strong>: 50-60% (避免网络拥塞)</li>
</ul>
<h2 id="可扩展性设计"><a class="header" href="#可扩展性设计">可扩展性设计</a></h2>
<h3 id="水平扩展策略"><a class="header" href="#水平扩展策略">水平扩展策略</a></h3>
<ul>
<li><strong>无状态服务</strong>: 业务服务层水平扩展</li>
<li><strong>数据分片</strong>: 按业务维度分片存储</li>
<li><strong>读写分离</strong>: 读副本支持查询扩展</li>
<li><strong>缓存层</strong>: 分布式缓存减少存储压力</li>
</ul>
<h3 id="垂直扩展优化"><a class="header" href="#垂直扩展优化">垂直扩展优化</a></h3>
<ul>
<li><strong>硬件升级</strong>: 更快的CPU/内存/存储</li>
<li><strong>NUMA优化</strong>: 多路服务器性能优化</li>
<li><strong>GPU加速</strong>: 特定计算任务GPU加速</li>
<li><strong>专用硬件</strong>: FPGA/智能网卡等专用设备</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="01-background.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="03-record-manager.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="01-background.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="03-record-manager.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
